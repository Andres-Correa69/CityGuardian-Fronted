<app-loader></app-loader>
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0">
                    Detalle del Reporte
                    <span *ngIf="report">- {{ report.title }}</span>
                </h5>
            </div>
            <button *ngIf="showEditButton()" class="btn btn-light btn-sm d-flex align-items-center"
                style="box-shadow: none;" (click)="editReport()">
                <i class="bi bi-pencil me-1"></i>
                <strong> Editar</strong>
            </button>
        </div>
        <div class="card-body" *ngIf="report">
            <!-- Sección de imágenes - solo si hay imágenes -->
            <div class="row mb-4" *ngIf="report.imageUrls && report.imageUrls.length > 0">
                <div class="col-12">
                    <h5>Imágenes del Reporte</h5>
                    <div class="row g-2">
                        <div class="col-md-4" *ngFor="let imageUrl of report.imageUrls">
                            <div class="image-container">
                                <img [src]="imageUrl" class="img-fluid rounded" alt="Imagen del reporte">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del reporte -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div>
                        <button class="btn ms-2 mb-3" [class.btn-warning]="report.important"
                            [class.btn-outline-warning]="!report.important" (click)="toggleImportant()">
                            <i class="bi" [class.bi-star-fill]="report.important"
                                [class.bi-star]="!report.important"></i>
                            {{ report.important ? 'Importante' : 'Marcar como importante' }}
                        </button>
                    </div>
                    <div>
                        <strong>Categoría:</strong> {{ report.category.name }}<br>
                        <strong>Ubicación:</strong>
                        <span *ngIf="report.location">
                            <br>
                            Latitud: {{ report.location.latitude }}<br>
                            Longitud: {{ report.location.longitude }}
                        </span>
                        <span *ngIf="!report.location">
                            <br>
                            No disponible
                        </span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex flex-column gap-2">
                        <button *ngIf="showVerifyButton()" class="btn btn-primary"
                            [disabled]="isButtonDisabled('VERIFIED')" (click)="verifyReport()">
                            <i class="bi bi-check-circle"></i> Verificar
                        </button>
                        <button *ngIf="showRejectButton()" class="btn btn-danger"
                            [disabled]="isButtonDisabled('REJECTED')" (click)="openRejectModal(rejectModal)">
                            <i class="bi bi-x-circle"></i> Rechazar
                        </button>
                        <button *ngIf="showResolveButton()" class="btn btn-success"
                            [disabled]="isButtonDisabled('RESOLVED')" (click)="resolveReport()">
                            <i class="bi bi-check-circle-fill"></i> Resolver
                        </button>
                        <button *ngIf="showReviewButton()" class="btn btn-info" [disabled]="isButtonDisabled('CREATED')"
                            (click)="reviewReport()">
                            <i class="bi bi-arrow-clockwise"></i> Enviar a Revisión
                        </button>
                    </div>
                </div>
            </div>
            <hr>
            <div class="mb-4">
                <strong>Descripción:</strong>
                <p>{{ report.description }}</p>
            </div>

            <!-- Historial de estados del reporte -->
            <div class="mb-4">
                <h5>Estado</h5>
                <div class="card p-3" style="background: #f8fafc; border-radius: 12px;">
                    <div *ngFor="let state of report.stateHistory; let last = last"
                        class="d-flex align-items-start mb-3 position-relative"
                        [ngStyle]="{'padding-bottom': !last ? '18px' : '0'}">
                        <!-- Línea vertical para conectar los estados -->
                        <div
                            style="width: 24px; display: flex; flex-direction: column; align-items: center; position: relative;">
                            <ng-container [ngSwitch]="state.status">
                                <span *ngSwitchCase="'CREATED'">
                                    <i class="bi bi-circle" style="color: #b0b0b0; font-size: 1.5rem;"></i>
                                </span>
                                <span *ngSwitchCase="'REJECTED'">
                                    <i class="bi bi-x-circle-fill" style="color: #ff5252; font-size: 1.5rem;"></i>
                                </span>
                                <span *ngSwitchCase="'VERIFIED'">
                                    <i class="bi bi-check-circle" style="color: #7cff6b; font-size: 1.5rem;"></i>
                                </span>
                                <span *ngSwitchCase="'RESOLVED'">
                                    <i class="bi bi-check-circle-fill" style="color: #00c853; font-size: 1.5rem;"></i>
                                </span>
                                <span *ngSwitchDefault>
                                    <i class="bi bi-dot" style="font-size: 1.5rem;"></i>
                                </span>
                            </ng-container>
                            <!-- Línea vertical solo si no es el último -->
                            <div *ngIf="!last" style="width: 2px; height: 32px; background: #d1d5db; margin-top: 2px;">
                            </div>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <div class="fw-semibold" style="font-size: 1.08rem;">
                                {{ getTranslationOfStatus(state.status) }}
                            </div>
                            <div class="text-muted" style="font-size: 0.97rem;">
                                {{ state.date | date:'d \'de\' MMMM \'del\' y hh:mm a' }}
                            </div>
                            <div *ngIf="state.status === 'REJECTED' && state.reason" class="mt-1">
                                <span class="fw-bold">motivo: </span> <span class="">{{ state.reason }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección del mapa - solo si hay ubicación -->
            <div *ngIf="report.location && report.location.latitude && report.location.longitude">
                <h5>Ubicación en el mapa</h5>

                <div class="mb-3">
                    <button class="btn btn-primary me-2" (click)="mostrarReportesCercanos()"
                        *ngIf="!mostrandoReportesCercanos">
                        Ver Reportes Cercanos
                    </button>

                    <button class="btn btn-warning me-2" (click)="mostrarZonasAltoRiesgo()"
                        *ngIf="mostrandoReportesCercanos && !mostrandoZonasRiesgo">
                        Ver Zonas de Alto Riesgo
                    </button>

                    <button class="btn btn-secondary" (click)="volverAMapaOriginal()"
                        *ngIf="mostrandoReportesCercanos || mostrandoZonasRiesgo">
                        Volver al Mapa Original
                    </button>
                </div>

                <div id="mapa-detalle" style="height: 300px; width: 100%; border-radius: 8px;"></div>
            </div>
        </div>
        <div class="card-body" *ngIf="!report">
            <p>Cargando información del reporte...</p>
        </div>
    </div>
</div>

<!-- Modal de Rechazo -->
<ng-template #rejectModal>
    <div class="modal-header">
        <h5 class="modal-title">Rechazar Reporte</h5>
        <button type="button" class="btn-close" (click)="modalService.dismissAll()"></button>
    </div>
    <div class="modal-body">
        <div class="mb-3">
            <label for="rejectReason" class="form-label">Motivo del rechazo:</label>
            <textarea class="form-control" id="rejectReason" rows="3" [(ngModel)]="rejectReason" required></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modalService.dismissAll()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="rejectReport()">Rechazar</button>
    </div>
</ng-template>

<!-- Template del Modal de Creación -->
<ng-template #editReportTemplate>
    <form (ngSubmit)="upadteReport()">
        <div class="mb-3">
            <label class="form-label">Título:</label>
            <input type="text" class="form-control" [(ngModel)]="newReport.title" name="title" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción:</label>
            <textarea class="form-control" [(ngModel)]="newReport.description" name="description" required></textarea>
        </div>

        <select class="form-select mb-3" [(ngModel)]="newReport.category.id" name="categoryId" required>
            <option value="">Selecciona una categoría</option>
            <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
        </select>

        <div class="mb-3">
            <label class="form-label">Imágenes:</label>
            <input type="file" class="form-control" (change)="onFileSelected($event)" multiple>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Editar Reporte</button>
        </div>
    </form>
</ng-template>